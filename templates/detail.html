{% extends "base.html" %}

{% block title %}{{ conversion.filename }} - MarkItDown API{% endblock %}

{% block content %}
<div class="detail-container">
    <div class="detail-header">
        <h1>Document Details</h1>
        <a href="{{ url_for('recent_conversions') }}" class="btn btn-small">‚Üê Back to List</a>
    </div>
    
    <div class="detail-grid">
        <!-- Left column: File info and preview -->
        <div class="detail-section">
            <div class="info-card">
                <h2>File Information</h2>
                {% if conversion.predicted_title %}
                <div class="info-item">
                    <strong>Predicted Title:</strong> {{ conversion.predicted_title }}
                </div>
                {% endif %}
                <div class="info-item">
                    <strong>Filename:</strong> {{ conversion.filename }}
                </div>
                <div class="info-item">
                    <strong>Upload Time:</strong> {{ conversion.upload_time.strftime('%Y-%m-%d %H:%M:%S') }}
                </div>
                <div class="info-item">
                    <strong>File Size:</strong> {{ "%.2f"|format(conversion.file_size / 1024) }} KB
                </div>
                <div class="info-item">
                    <strong>Document ID:</strong> {{ conversion.id }}
                </div>
            </div>
            
            {% if is_pdf or is_image %}
            <div class="info-card preview-card">
                <h2>File Preview</h2>
                <div class="preview-container">
                    {% if is_pdf %}
                    <embed src="{{ url_for('serve_upload', filename=conversion.original_path.split('/')[-1]) }}" 
                           type="application/pdf" 
                           width="100%" 
                           height="600px">
                    {% elif is_image %}
                    <img src="{{ url_for('serve_upload', filename=conversion.original_path.split('/')[-1]) }}" 
                         alt="{{ conversion.filename }}"
                         class="preview-image">
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Right column: Markdown content -->
        <div class="detail-section">
            {% if conversion.summary_content %}
            <div class="info-card markdown-card">
                <h2>AI-Processed Summary & Corrections</h2>
                <div class="markdown-display">
                    <pre>{{ conversion.summary_content }}</pre>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="copySummary()">üìã Copy Summary</button>
                    <button class="btn btn-small" onclick="downloadSummary()">‚¨áÔ∏è Download Summary</button>
                </div>
            </div>
            {% endif %}
            
            <div class="info-card markdown-card">
                <h2>{% if conversion.summary_content %}Original {% endif %}Converted Markdown</h2>
                <div class="markdown-display">
                    <pre>{{ conversion.markdown_content }}</pre>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="copyMarkdown()">üìã Copy Markdown</button>
                    <button class="btn btn-small" onclick="downloadMarkdown()">‚¨áÔ∏è Download as .md</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function copySummary() {
    const summaryText = `{{ conversion.summary_content|e }}`;
    navigator.clipboard.writeText(summaryText).then(() => {
        alert('Summary copied to clipboard!');
    }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy summary to clipboard');
    });
}

function downloadSummary() {
    const summaryText = `{{ conversion.summary_content|e }}`;
    const blob = new Blob([summaryText], { type: 'text/markdown' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = '{{ conversion.filename }}'.replace(/\.[^/.]+$/, '_summary.md');
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
}

function copyMarkdown() {
    const markdownText = `{{ conversion.markdown_content|e }}`;
    navigator.clipboard.writeText(markdownText).then(() => {
        alert('Markdown copied to clipboard!');
    }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy markdown to clipboard');
    });
}

function downloadMarkdown() {
    const markdownText = `{{ conversion.markdown_content|e }}`;
    const blob = new Blob([markdownText], { type: 'text/markdown' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = '{{ conversion.filename }}'.replace(/\.[^/.]+$/, '.md');
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
}
</script>
{% endblock %}
